<!DOCTYPE html>
<html>
<head>
    <title>Drone Voxel - Düzeltilmiş Versiyon</title>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { width: 100%; height: 100vh; cursor: crosshair; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #0f0; font-family: monospace; font-size: 24px; text-align: center;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="loading">DRONE SİSTEMİ BAŞLATILIYOR...<br><span style="font-size:16px; color:#aaa;">(Uydu verileri işleniyor)</span></div>
    <canvas id="screen"></canvas>

<script>
const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');

// --- ÇÖZÜNÜRLÜK AYARI ---
// Daha geniş ve net görmek için çözünürlüğü biraz artırdım
const screenWidth = 400; 
const screenHeight = 300;
canvas.width = screenWidth;
canvas.height = screenHeight;

// -- DEĞİŞKENLER --
let mapSize = 1024;
let colorData = null;
let heightData = null;
let loaded = false;

let drone = {
    x: 512, y: 512, 
    height: 150, // Yükseklik artırıldı (Daha ferah görüş)
    angle: 0, 
    horizon: 100, 
    speed: 0
};

// -- RESİMLERİ YÜKLEME --
function loadMaps() {
    const imgColor = new Image();
    const imgHeight = new Image();
    
    imgColor.crossOrigin = "Anonymous";
    imgHeight.crossOrigin = "Anonymous";

    let imagesLoaded = 0;

    function onImageLoad() {
        imagesLoaded++;
        if (imagesLoaded === 2) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = mapSize;
            tempCanvas.height = mapSize;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(imgColor, 0, 0);
            colorData = tempCtx.getImageData(0, 0, mapSize, mapSize).data;

            tempCtx.drawImage(imgHeight, 0, 0);
            heightData = tempCtx.getImageData(0, 0, mapSize, mapSize).data;

            loaded = true;
            document.getElementById('loading').style.display = 'none';
            gameLoop();
        }
    }

    imgColor.src = 'color.png'; 
    imgHeight.src = 'height.png';
    
    imgColor.onload = onImageLoad;
    imgHeight.onload = onImageLoad;
    
    imgColor.onerror = () => alert("HATA: Resimler GitHub'da bulunamadı!");
}

// -- KONTROLLER --
let input = { forward: false };

window.onmousemove = (e) => {
    let xRatio = (e.clientX / window.innerWidth - 0.5); 
    let yRatio = (e.clientY / window.innerHeight - 0.5);

    // Mouse Sağa/Sola -> Dönüş
    drone.angle += xRatio * 0.1; 
    
    // Mouse Yukarı/Aşağı -> Ufuk Çizgisi (DÜZELTİLDİ)
    // Eski kodda "-" vardı, "+" yaparak tersliği düzelttik.
    // Ayrıca hassasiyeti ayarladık.
    drone.horizon = 150 + (yRatio * 400);
};

window.onmousedown = () => input.forward = true;
window.onmouseup = () => input.forward = false;
window.onkeydown = (e) => { if(e.key === 'w' || e.key === 'W') input.forward = true; };
window.onkeyup = (e) => { if(e.key === 'w' || e.key === 'W') input.forward = false; };

// -- OYUN DÖNGÜSÜ --
function gameLoop() {
    if (!loaded) return;

    if (input.forward) drone.speed = 3; 
    else drone.speed *= 0.92;

    drone.x += Math.cos(drone.angle) * drone.speed;
    drone.y += Math.sin(drone.angle) * drone.speed;

    let mapX = Math.floor(drone.x) & (mapSize - 1);
    let mapY = Math.floor(drone.y) & (mapSize - 1);
    let mapIndex = (mapY * mapSize + mapX) * 4;

    // Otomatik Yükseklik: Yerden 120 birim yukarıda tut (Zoom hissini azaltır)
    let groundHeight = heightData[mapIndex];
    drone.height = groundHeight + 120; 

    // -- RENDERING --
    let imgData = ctx.createImageData(screenWidth, screenHeight);
    let buf = new Uint32Array(imgData.data.buffer);
    
    buf.fill(0xFFFFCC66); 

    let sinA = Math.sin(drone.angle);
    let cosA = Math.cos(drone.angle);
    
    // Görüş mesafesini artırdım
    let viewDist = 1000; 

    for (let i = 0; i < screenWidth; i++) {
        let deltaX = (cosA * viewDist - sinA * (i - screenWidth/2)) / viewDist;
        let deltaY = (sinA * viewDist + cosA * (i - screenWidth/2)) / viewDist;
        
        let posX = drone.x;
        let posY = drone.y;
        let maxH = screenHeight;

        for (let z = 1; z < viewDist; z += 2) { // z adımını artırdım (Performans)
            posX += deltaX * 2;
            posY += deltaY * 2;
            
            let mX = Math.floor(posX) & (mapSize - 1);
            let mY = Math.floor(posY) & (mapSize - 1);
            let offset = (mY * mapSize + mX) * 4;
            
            let h = heightData[offset];
            
            // ZOOM DÜZELTMESİ BURADA:
            // Çarpanı 240'tan 120'ye düşürdüm. 
            // Bu, dağları daha basık ve uzak gösterir.
            let hOnScreen = (drone.height - h) / z * 120 + drone.horizon;

            if (hOnScreen < maxH) {
                let r = colorData[offset];
                let g = colorData[offset+1];
                let b = colorData[offset+2];
                let color = (255 << 24) | (b << 16) | (g << 8) | r;

                for (let y = Math.max(0, hOnScreen|0); y < maxH; y++) {
                    buf[y * screenWidth + i] = color;
                }
                maxH = hOnScreen;
            }
        }
    }

    ctx.putImageData(imgData, 0, 0);
    requestAnimationFrame(gameLoop);
}

loadMaps();
</script>
</body>
</html>
