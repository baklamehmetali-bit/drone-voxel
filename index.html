<!DOCTYPE html>
<html>
<head>
    <title>Drone Voxel - Hassas Kontrol</title>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { width: 100%; height: 100vh; cursor: crosshair; }
        #ui {
            position: absolute; top: 10px; left: 10px;
            color: #0f0; font-family: monospace; font-size: 16px; font-weight: bold;
            text-shadow: 1px 1px 0 #000; pointer-events: none;
        }
        #center-marker {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            pointer-events: none;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: sans-serif; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="ui">
        KAMERA: [P]<br>
        GAZ: [W] veya [Sol Tık]<br>
        YÖN: Mouse (Orta alan düz uçuş sağlar)
    </div>
    <div id="center-marker"></div>
    <div id="loading">HARİTA YÜKLENİYOR...</div>
    <canvas id="screen"></canvas>

<script>
const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');

const screenWidth = 400; 
const screenHeight = 300;
canvas.width = screenWidth;
canvas.height = screenHeight;

// -- AYARLAR --
let mapSize = 1024;
let colorData = null;
let heightData = null;
let loaded = false;
let cameraMode = 3; 

let drone = {
    x: 512, y: 512, 
    height: 150, 
    angle: 0, 
    horizon: 120, // Varsayılan Ufuk Çizgisi
    speed: 0
};

// -- RESİMLERİ YÜKLE --
function loadMaps() {
    const imgColor = new Image();
    const imgHeight = new Image();
    imgColor.crossOrigin = "Anonymous";
    imgHeight.crossOrigin = "Anonymous";

    let imagesLoaded = 0;
    function onImageLoad() {
        imagesLoaded++;
        if (imagesLoaded === 2) {
            const tCanvas = document.createElement('canvas');
            tCanvas.width = mapSize; tCanvas.height = mapSize;
            const tCtx = tCanvas.getContext('2d');

            tCtx.drawImage(imgColor, 0, 0);
            colorData = tCtx.getImageData(0, 0, mapSize, mapSize).data;

            tCtx.drawImage(imgHeight, 0, 0);
            heightData = tCtx.getImageData(0, 0, mapSize, mapSize).data;

            loaded = true;
            document.getElementById('loading').style.display = 'none';
            gameLoop();
        }
    }

    imgColor.src = 'color.png'; 
    imgHeight.src = 'height.png';
    imgColor.onload = onImageLoad;
    imgHeight.onload = onImageLoad;
}

// -- KONTROLLER --
let input = { forward: false };

window.onkeydown = (e) => {
    if(e.key === 'w' || e.key === 'W') input.forward = true;
    if(e.key === 'p' || e.key === 'P') {
        cameraMode++; 
        if(cameraMode > 3) cameraMode = 1; 
    }
};

window.onkeyup = (e) => {
    if(e.key === 'w' || e.key === 'W') input.forward = false;
};

// --- GELİŞMİŞ MOUSE KONTROLÜ ---
window.onmousemove = (e) => {
    // 1. Yatay Hareket (Dönüş) - Değişmedi
    let xRatio = (e.clientX / window.innerWidth - 0.5); 
    drone.angle += xRatio * 0.1; 

    // 2. Dikey Hareket (Bakış) - "ÖLÜ BÖLGE" Mantığı
    let yRatio = (e.clientY / window.innerHeight - 0.5); // -0.5 ile +0.5 arası değer

    // Eğer mouse ekranın tam ortasındaysa (yüzde 15'lik alan)
    if (yRatio > -0.15 && yRatio < 0.15) {
        // DÜZ GİT: Ufuk çizgisini sabitle
        drone.horizon = 120; 
        document.getElementById('center-marker').style.borderColor = "rgba(0, 255, 0, 0.5)"; // Yeşil ol
    } else {
        // HAREKET ET: Ama hassasiyeti düşürdük (Çarpanı azalttık)
        // Eskiden 400 ile çarpıyorduk, şimdi 200 ile çarpıyoruz (Daha yavaş hareket)
        drone.horizon = 120 + (yRatio * 200);
        document.getElementById('center-marker').style.borderColor = "rgba(255, 255, 255, 0.3)"; // Beyaz ol
    }
};

window.onmousedown = () => input.forward = true;
window.onmouseup = () => input.forward = false;

// -- DRONE MODELİ --
function drawDroneModel() {
    let cx = screenWidth / 2;
    let cy = screenHeight - 60; 
    if (cameraMode === 2) cy = screenHeight - 100;

    // Gövde
    ctx.fillStyle = "#333"; ctx.fillRect(cx - 20, cy, 40, 10);
    
    // Kollar
    ctx.strokeStyle = "#555"; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(cx - 20, cy + 5); ctx.lineTo(cx - 40, cy - 10);
    ctx.moveTo(cx + 20, cy + 5); ctx.lineTo(cx + 40, cy - 10); 
    ctx.moveTo(cx - 20, cy + 5); ctx.lineTo(cx - 40, cy + 20); 
    ctx.moveTo(cx + 20, cy + 5); ctx.lineTo(cx + 40, cy + 20); 
    ctx.stroke();

    // Pervaneler
    ctx.fillStyle = "rgba(200, 255, 255, 0.5)";
    ctx.beginPath(); ctx.arc(cx - 40, cy - 10, 14, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + 40, cy - 10, 14, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx - 40, cy + 20, 14, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + 40, cy + 20, 14, 0, Math.PI*2); ctx.fill();
    
    // Işık
    ctx.fillStyle = input.forward ? "#0f0" : "#f
