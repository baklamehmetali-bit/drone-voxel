<!DOCTYPE html>
<html>
<head>
    <title>Drone Voxel - HD Uçuş</title>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { width: 100%; height: 100vh; cursor: crosshair; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #0f0; font-family: monospace; font-size: 24px; text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading">UYDU VERİLERİ YÜKLENİYOR...<br><span style="font-size:16px; color:#aaa;">(Bu işlem 10-15 saniye sürebilir)</span></div>
    <canvas id="screen"></canvas>

<script>
const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');

// Ekran Çözünürlüğü (Performans için)
const screenWidth = 320; 
const screenHeight = 200;
canvas.width = screenWidth;
canvas.height = screenHeight;

// -- DEĞİŞKENLER --
let mapSize = 1024;
let colorData = null;
let heightData = null;
let loaded = false;

let drone = {
    x: 512, y: 512, 
    height: 50, 
    angle: 0, 
    horizon: 100, 
    speed: 0
};

// -- RESİMLERİ YÜKLEME (GitHub'daki dosyaları okur) --
function loadMaps() {
    const imgColor = new Image();
    const imgHeight = new Image();
    
    // "Cross-Origin" hatasını önlemek için önemli
    imgColor.crossOrigin = "Anonymous";
    imgHeight.crossOrigin = "Anonymous";

    let imagesLoaded = 0;

    function onImageLoad() {
        imagesLoaded++;
        if (imagesLoaded === 2) {
            // Resim verilerini Canvas'a aktar
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = mapSize;
            tempCanvas.height = mapSize;
            const tempCtx = tempCanvas.getContext('2d');

            // 1. Renk Haritası
            tempCtx.drawImage(imgColor, 0, 0);
            colorData = tempCtx.getImageData(0, 0, mapSize, mapSize).data;

            // 2. Yükseklik Haritası
            tempCtx.drawImage(imgHeight, 0, 0);
            heightData = tempCtx.getImageData(0, 0, mapSize, mapSize).data;

            loaded = true;
            document.getElementById('loading').style.display = 'none';
            gameLoop(); // Oyunu Başlat
        }
    }

    // Dosya isimleri GitHub'dakilerle AYNI olmalı
    imgColor.src = 'color.png'; 
    imgHeight.src = 'height.png';
    
    imgColor.onload = onImageLoad;
    imgHeight.onload = onImageLoad;
    
    imgColor.onerror = () => alert("HATA: 'color.png' dosyası bulunamadı veya yüklenemedi!");
    imgHeight.onerror = () => alert("HATA: 'height.png' dosyası bulunamadı!");
}

// -- KONTROLLER (MOUSE + KLAVYE) --
let input = { forward: false };

// Mouse Hareketi
window.onmousemove = (e) => {
    // Ekranın ortasına göre hesapla
    let xRatio = (e.clientX / window.innerWidth - 0.5); 
    let yRatio = (e.clientY / window.innerHeight - 0.5);

    // Mouse Sağa/Sola -> Dönüş
    drone.angle += xRatio * 0.15; 
    
    // Mouse İleri/Geri -> Kafa Eğme (Horizon)
    drone.horizon = 100 - (yRatio * 300);
};

// Mouse Tıklama -> Gaz
window.onmousedown = () => input.forward = true;
window.onmouseup = () => input.forward = false;

// Klavye (W tuşu)
window.onkeydown = (e) => { if(e.key === 'w' || e.key === 'W') input.forward = true; };
window.onkeyup = (e) => { if(e.key === 'w' || e.key === 'W') input.forward = false; };

// -- OYUN DÖNGÜSÜ --
function gameLoop() {
    if (!loaded) return;

    // Hareket Fiziği
    if (input.forward) drone.speed = 2.5; // Hız
    else drone.speed *= 0.92; // Sürtünme

    drone.x += Math.cos(drone.angle) * drone.speed;
    drone.y += Math.sin(drone.angle) * drone.speed;

    // Harita dışına çıkarsa döngü (Sonsuz dünya)
    // Bitwise işlemler (&) performansı artırır
    let mapX = Math.floor(drone.x) & (mapSize - 1);
    let mapY = Math.floor(drone.y) & (mapSize - 1);
    let mapIndex = (mapY * mapSize + mapX) * 4;

    // Yükseklik hesapla (Zemin + 50 birim)
    // Sadece Red kanalını (r) okuyoruz
    let groundHeight = heightData[mapIndex];
    drone.height = groundHeight + 50; 

    // -- RENDERING (VOXEL SPACE) --
    let imgData = ctx.createImageData(screenWidth, screenHeight);
    let buf = new Uint32Array(imgData.data.buffer);
    
    // Gökyüzü Rengi (Açık Mavi)
    buf.fill(0xFFFFCC66); 

    let sinA = Math.sin(drone.angle);
    let cosA = Math.cos(drone.angle);
    let viewDist = 800; 

    for (let i = 0; i < screenWidth; i++) {
        // Işın atma (Raycasting)
        let deltaX = (cosA * viewDist - sinA * (i - screenWidth/2)) / viewDist;
        let deltaY = (sinA * viewDist + cosA * (i - screenWidth/2)) / viewDist;
        
        let posX = drone.x;
        let posY = drone.y;
        let maxH = screenHeight;

        for (let z = 1; z < viewDist; z += 1.5) {
            posX += deltaX * 1.5;
            posY += deltaY * 1.5;
            
            let mX = Math.floor(posX) & (mapSize - 1);
            let mY = Math.floor(posY) & (mapSize - 1);
            let offset = (mY * mapSize + mX) * 4;
            
            let h = heightData[offset];
            let hOnScreen = (drone.height - h) / z * 240 + drone.horizon;

            if (hOnScreen < maxH) {
                // Renk okuma (RGBA)
                let r = colorData[offset];
                let g = colorData[offset+1];
                let b = colorData[offset+2];
                
                // ABGR formatına çevir
                let color = (255 << 24) | (b << 16) | (g << 8) | r;

                for (let y = Math.max(0, hOnScreen|0); y < maxH; y++) {
                    buf[y * screenWidth + i] = color;
                }
                maxH = hOnScreen;
            }
        }
    }

    ctx.putImageData(imgData, 0, 0);
    requestAnimationFrame(gameLoop);
}

// Başlat
loadMaps();
</script>
</body>
</html>
